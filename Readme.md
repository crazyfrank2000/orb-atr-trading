# ORB Trading Strategy 使用指南

## 项目说明
ORB Trading Strategy 是一个基于开盘区间突破 (Opening Range Breakout) 策略的自动化交易系统。系统从 Interactive Brokers (IBKR) 获取 5 分钟 K 线数据，根据每个交易日开盘后的任意一个 5 分钟 K 线形成的价格区间进行交易决策。本系统支持多种标的，包括黄金 (XAU)、股票 (如 TQQQ) 等。

## TQQQ与XAU平仓逻辑对比

TQQQ-ATR-ORB与原有的XAU-ATR-ORB策略在平仓逻辑上有以下重要区别：

### TQQQ平仓逻辑
1. **动态收盘时间监控**：
   - 系统设置3:50pm作为开始平仓的时间点
   - 在3:45pm-3:50pm之间会显示距离平仓的倒计时
   - 3:50pm触发自动平仓，确保在市场收盘前完成交易
   - 在3:40pm之后不再开新仓，避免临近收盘开仓

2. **时区处理优化**：
   - 所有时间统一使用美东时区(Eastern Time)处理
   - 修复了时区不匹配导致的监控问题
   
3. **止损价格精度**：
   - 所有止损价格精确控制在两位小数
   - 避免价格精度过高造成的下单问题

4. **ATR计算**：
   - 包含夜盘数据计算ATR，提供更全面的波动性度量

5. **详细交易报告**：
   - 提供实时未实现盈亏计算
   - 程序结束前打印完整的交易总结

### XAU平仓逻辑
1. **固定持仓时间**：
   - 默认持仓时间为60分钟
   - 持仓60分钟后自动市价平仓
   - 无收盘时间特殊处理

2. **止损设置**：
   - 使用常规止损单，无特殊精度控制
   - 触发止损后自动平仓

两种策略都采用ATR计算止损距离，但TQQQ策略更适合美股交易时段，有专门的收盘前平仓机制，而XAU策略更适合24小时交易的产品。

## 安装和设置

### 前置需求
1. Interactive Brokers 账户
2. Python 3.6+ 环境
3. 必要的 Python 依赖包:
   - ib_insync
   - pandas
   - numpy
   - pytz

### 安装依赖
```bash
pip install ib_insync pandas numpy pytz
```

### 文件夹结构
系统会自动创建以下文件夹：
- `logs/`: 存储日志文件
- `reports/`: 存储交易报告 CSV 文件
- `data/`: 存储临时数据文件

## IBKR连接设置
- host: "127.0.0.1"  # TWS/Gateway主机地址
- port: 7497  # 端口号 (纸上交易为7497，实盘为7496)
- client_id: 1  # 客户端ID

## 交易标的选择
系统会自动尝试获取以下黄金交易标的（按优先级）：
1. XAUUSD Spot (现货黄金)
2. TQQQ

## 交易逻辑

系统交易逻辑基于以下规则：

1. **信号生成**
   - 第一根5分钟K线上涨 → 做多
   - 第一根5分钟K线下跌 → 做空
   - 第一根K线为十字星（无变化）→ 当天不交易
   - 实际计算公式: 价格变化百分比 = (收盘价 - 开盘价) / 开盘价 * 100

2. **止损设置**
   - 做多: 止损设置在 收盘价 - ATR * 0.05
   - 做空: 止损设置在 收盘价 + ATR * 0.05
   - ATR 基于过去 14 天的日线数据计算

3. **仓位管理**
   - 风险计算: 仓位风险 = ⌊账户资金×1% / R⌋
   - 杠杆计算: 仓位杠杆 = ⌊账户资金×杠杆 / 当前价格⌋
   - 最终仓位: 下单数量 = min(仓位风险, 仓位杠杆)
   - 默认账户大小: $25,000
   - 最大杠杆: 4倍
   - 单笔交易风险: 账户的1%

4. **监控和出场**
   - 止损触发 → 自动平仓
   - 持仓时间超过设定时长 → 市价平仓
   - 价格变动 → 更新交易状态

5. **报告系统**
   - 生成CSV报告，记录每笔交易详情
   - 记录包括: 入场/出场时间、价格、盈亏金额、盈亏百分比、持仓时间等

## 执行策略步骤

1. **初始化准备**
   - 连接到 IBKR 交易接口
   - 获取并确认交易标的
   - 等待下一个完整5分钟K线形成

2. **交易信号分析**
   - 获取最新5分钟K线数据
   - 计算日线ATR
   - 分析价格变化生成交易信号

3. **仓位计算**
   - 基于风险和杠杆计算仓位大小
   - 验证实际风险和杠杆水平

4. **执行交易**
   - 下单入场
   - 设置止损单
   - 监控持仓并根据策略调整

5. **交易总结**
   - 记录交易结果
   - 生成日线报告
   - 更新CSV交易记录

## 运行系统
```bash
python XAU-ATR-ORB.py
```

## 自定义参数
在脚本头部可以调整以下参数:
- `ACCOUNT_SIZE`: 账户资金大小
- `LEVERAGE`: 最大杠杆倍数
- `RISK_PCT`: 每笔交易风险比例

## 注意事项

1. 请在使用前确保了解交易风险
2. 建议在纸上交易环境中充分测试后再用于实盘交易
3. 确保IBKR账户有足够的资金和交易权限
4. 黄金交易具有较大波动性，请谨慎设置风险参数

## 日志和报告
- 日志文件保存在 `logs/xau_atr_trading.log`
- 交易报告保存在 `reports/XAU_trades_YYYY-MM-DD.csv`


关于 **“R 值”在交易策略中的定义和计算**，尤其在结合 **ATR** 的框架中，通常有以下几类主流方法，它们常见于系统化交易研究和经典论文（如 Van Tharp 的风险单位定义、Turtle Trading 原则、以及许多关于趋势跟踪和波动性策略的论文）：

---

### 🧩 R 的几种定义方式（来自论文与实务）

---

#### **方式一：固定比例乘以 ATR（最常见）**

这是你目前采用的形式，源自风险平衡思想和 Van Tharp 定义的 *1R* 单位风险：

\[
R = k \cdot ATR_n
\]

其中：

- \( n \) 是ATR的周期（如14日或20日）
- \( k \) 是比例常数，一般为 0.5%、1%、5%等
- 通常用于动态止损、仓位控制和波动率平衡

📘 **出处**：
- *Van Tharp – Trade Your Way to Financial Freedom*：提出了R乘数模型
- *Position Sizing Effectiveness Using ATR* (Wang et al.)

---

#### **方式二：基于入场价与止损价的距离定义R**

\[
R = |P_{\text{entry}} - P_{\text{stop}}|
\]

然后将**实际盈亏**除以这个R值，得到收益的R倍：

\[
\text{R-multiple} = \frac{\text{Profit or Loss}}{R}
\]

📘 **用途**：
- R-multiple分析用于统计盈亏分布（如平均收益为+1.8R，亏损为-1R）

📘 **引用**：
- *Tharp (2000)*: 用R值衡量策略统计特性
- *Turtle Trading Rules*：将R视作一个完整单位波动风险

---

#### **方式三：根据波动百分比设定（动态R）**

R 设置为资产价格的一定百分比：

\[
R = \alpha \cdot P_{\text{current}}
\]

比如：
- R = 1% 当前价格
- 与移动止损配合，或用于趋势突破策略

📘 **特点**：
- 适用于没有明显的均值或趋势支撑的资产
- 与ATR无关，依赖于资产本身价格比例

---

#### **方式四：波动分布回测优化（Quant法）**

一些定量研究将R视为一个待优化参数，形式如：

\[
R_i = f(\text{volatility}, \text{trend strength}, \text{liquidity})
\]

并通过历史回测找到最优组合，如：

- 在不同资产和市场阶段下，找最合适的R定义
- 与止盈、移动止损或期望最大回撤组合优化

📘 **引用**：
- *Grinold & Kahn - Active Portfolio Management*：以信息比与volatility关系构建R因子

---

### 🧠 总结表格：

| R 计算方法       | 公式形式                              | 优点                          | 典型应用           |
|------------------|----------------------------------------|-------------------------------|--------------------|
| ATR比例型        | \( R = k \cdot ATR \)                 | 与波动同步，适应性强          | 你当前使用方式     |
| 固定价差型        | \( R = |P_{\text{entry}} - P_{\text{stop}}| \) | 精准控制止损空间             | Turtle / Tharp     |
| 百分比价格型      | \( R = \alpha \cdot P \)              | 简单适用无趋势品种             | 突破策略、定投策略 |
| 优化搜索型        | 回测最优 \( R^* \)                    | 自适应、性能最优              | 机构量化模型       |

---

你的程序 **应使用日ATR**（`1 day` K线）是**正确的选择**，这与大多数经典策略论文中定义的 **R 值和波动性单位**保持一致。下面详细解释原因：

---

### ✅ 为什么使用“日ATR”而不是“5分钟ATR”？

---

#### 🧭 **1. R 是衡量“单位波动风险”的标准参考**
- 在交易策略中，**R 是你愿意承受的“单位风险”**，它应当反映 **市场的典型波动区间**；
- 如果你基于“5分钟ATR”，R 的波动会非常剧烈、难以稳定控制仓位大小；
- 而“日ATR”更稳定，反映近期价格的真实波动环境。

📘 **参考模型**：
- Turtle Trading 使用 20日ATR；
- Van Tharp 的 R-multiple 模型建议 R 设定基于 **日线级别的止损距离**；
- 许多 CTA（商品交易顾问）策略也是以日ATR调仓和控制下单大小。

---

#### 🕰️ **2. 5分钟K线用于“入场判断”，但不适合用于风险预算**
- 你的程序逻辑是：  
  用 5分钟K 判断**方向**（收盘价 vs 开盘价）  
  用 日ATR 计算 **R值 → 仓位 → 止损**

这非常合理，因为：
- **入场时机**基于短周期；
- **仓位大小 & 止损设置**必须有一个稳定的波动锚点（日ATR）；

---

#### 🎯 **3. 实际对比：波动性尺度不一样**

比如 GLD 的示例：

| 周期     | ATR 值 (示例) |
|----------|----------------|
| 5分钟ATR | 0.25 ~ 0.60    |
| 日ATR    | 6.0 ~ 8.0      |

如果用 5分钟ATR 来设定 R，你的风险距离会远远小于实际价格波动范围，从而：

- 下单过多 → 杠杆超出；
- 止损频繁触发 → 被噪音洗掉。

---

### ✅ 最佳实践建议：

| 用途       | 使用K线周期 | 说明                         |
|------------|-------------|------------------------------|
| 判断方向   | 5分钟       | 最近一根K线涨跌判断          |
| 计算R      | 1天         | 稳定波动估计                  |
| 控制仓位   | 1天ATR      | 用于量化下单股数             |
| 设置止损   | 1天ATR ± R  | 比如 BUY 时止损 = close - R |

---

### ✅ 回答结论：

你的程序使用 **`1 day` 的ATR 来计算 R 值是对的**，这完全符合：
- 策略论文的主流定义；
- 实战中稳健控制风险的需求；
- Turtle、Tharp、以及CTA基金的规范化做法。

